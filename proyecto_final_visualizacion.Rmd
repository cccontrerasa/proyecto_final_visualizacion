---
title: "Análisis de datos de estudiantes de la UTEM (campus, carrera, comuna)"
output: 
  flexdashboard::flex_dashboard:
    theme: spacelab
    source_code: embed
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(plyr)
library(flexdashboard)
library(shinyWidgets)
library(shiny)
library(tidyverse)
library(janitor)
library(magrittr)
library(leaflet)
library(DT)
library(plotly)
library(shinydashboard)
library(knitr)
library(htmltools)
```

```{r global, include = FALSE}
estudiantes <- read.csv2("EstudiantesUtemPregradoDiurnoDesde2014.csv",fileEncoding='latin1',check.names=F)

estudiantes <- estudiantes %>%
    mutate(latitud_campus = case_when(
            campus == "PROVIDENCIA" ~ -33.43432589824217,
            campus == "MACUL" ~ -33.466004620965656,
            TRUE ~ -33.44836932283062
      ),
          longitud_campus = case_when(
            campus == "PROVIDENCIA" ~ -70.62557864602474,
            campus == "MACUL" ~ -70.5970461754169,
            TRUE ~ -70.65829166007629
      )
    )

#"https://github.com/altazor-1967/Comunas-de-Chile/blob/master/Latitud%20-%20Longitud%20Chile.csv"
LatLonChile <- read.csv2("Latitud - Longitud Chile.csv",fileEncoding='latin1',check.names=F)


LatLonChile <- LatLonChile %>%
  mutate(latitud = as.numeric(latitud),
         longitud = as.numeric(longitud)) %>%
  rename(latitud_comuna = latitud, longitud_comuna = longitud)

LatLonChile <- LatLonChile[, !names(LatLonChile) %in% c("cut", "provincia", "region")]

estudiantes <- merge(x = estudiantes, y = LatLonChile, by = "comuna")


sexo_list <- sort(unique(estudiantes$sexo))
nacionalidad_list <- sort(unique(estudiantes$nacionalidad))
carrera_list <- sort(unique(estudiantes$carrera))
facultad_list <- sort(unique(estudiantes$facultad))
comuna_list <- sort(unique(estudiantes$comuna))
region_list <- sort(unique(estudiantes$region))

sexo_list2 <- sort(unique(estudiantes$sexo))
nacionalidad_list2 <- sort(unique(estudiantes$nacionalidad))
carrera_list2 <- sort(unique(estudiantes$carrera))
region_list2 <- sort(unique(estudiantes$region))


sexo_list3 <- sort(unique(estudiantes$sexo))
nacionalidad_list3 <- sort(unique(estudiantes$nacionalidad))
escuela_list3 <- sort(unique(estudiantes$escuela))
region_list3 <- sort(unique(estudiantes$region))
```


# Home Page {data-icon="ion-home"}

```{r}
h2("Distribución de estudiantes de la UTEM", style = "text-align:center; font-weight:bold;")
h5("Análisis de datos de estudiantes de la UTEM (campus, carrera, comuna)", style = "text-align:center;")
```

## Column {.data-width=650}

```{r include_image, echo=FALSE}
img_file <- "FondoUTEM.png"
img_div <- div(
  style = "display:flex; justify-content:center;",
  img(src = img_file, style = "max-width:100%; opacity:0.5;")
)
img_div
```

```{r}
actionButton("show_popup1", "Distribución por Campus", style = "position: absolute; top: 35%; left: 10%; width: 275px")
actionButton("show_popup2", "Distribución por Comuna", style = "position: absolute; top: 50%; left: 10%; width: 275px")
actionButton("show_popup3", "Distribución por Carrera", style = "position: absolute; top: 65%; left: 10%; width: 275px")
actionButton("show_popup4", "Acerca de", style = "position: absolute; top: 80%; left: 10%; width: 275px")

observeEvent(input$show_popup1, {
  showModal(modalDialog(
    title = "Estudiantes por campus",
    p("En esta sección podrá consultar la cantidad de alumnos por Campus filtrando por género, carrera, nacionalidad, comuna y región."),
    footer = modalButton("Close")
  ))
})

observeEvent(input$show_popup2, {
  showModal(modalDialog(
    title = "Estudiantes por comuna",
    p("En esta sección podrá consultar la cantidad de alumnos por comuna filtrando por género, carrera, nacionalidad, comuna y región."),
    footer = modalButton("Close")
  ))
})


observeEvent(input$show_popup3, {
  showModal(modalDialog(
    title = "Distribución por carrera",
    p("En esta sección podrá consultar la cantidad de alumnos por carrera filtrando por género, carrera, nacionalidad, comuna y región."),
    footer = modalButton("Close")
  ))
})

observeEvent(input$show_popup4, {
  showModal(modalDialog(
    title = "Acerca de",
    p("Dashboard desarrollado como proyecto final del módulo 4 del diplomado de Análisis de Datos. Desarrollado por Marco Araya, Carolina Vera, Cristian Contreras, Fredy Zúñiga."),
    footer = modalButton("Close")
  ))
})
```

# Estudiantes por Campus {data-icon="ion-earth"}

## Inputs {.sidebar data-width="300"}

```{r}
pickerInput("sexo",
            label = "Seleccione género",
            choices = sexo_list,
            selected = sexo_list, 
            options = list(`actions-box` = TRUE),
          multiple = TRUE)
pickerInput("carrera",
            label = "Seleccione Carrera",
            choices = carrera_list,
            selected = carrera_list[1], 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)
pickerInput("nacionalidad",
            label = "Seleccione nacionalidad",
            choices = nacionalidad_list,
            selected = nacionalidad_list[1], 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)


actionButton("update1", "Update")


```

## Column

### Mapa de campus

```{r}
df_bar = eventReactive(input$update1, {
    estudiantesTmp <- estudiantes %>%
      filter(sexo %in% input$sexo,
             carrera %in% input$carrera,
             nacionalidad %in% input$nacionalidad) %>%
      group_by(campus, longitud_campus, latitud_campus) %>%
      summarise(cantidad = n())
  })


renderLeaflet({
leaflet() %>%
  #setView(lng = -71.1, lat =42.38, zoom =12) %>%
  addTiles() %>%
  addCircleMarkers(lng = ~longitud_campus,
             lat = ~latitud_campus,
             data = df_bar(),
             radius = ~sqrt(cantidad),
            popup = ~paste(
              "Campus: ", `campus`, "<br>",
              "Longitud: ", `longitud_campus`, "<br>",
              "Latitud: ", `latitud_campus`, "<br>",
            "Cantidad de estudiantes: ", `cantidad`
            )
            ) %>%
  addProviderTiles(providers$CartoDB.Positron)
})


#renderPlotly({
#p1 <- ggplotly(
#  ggplot(data = df_bar(), mapping = aes(x = campus)) +
#    geom_bar()
#)
#  })



```




# Estudiantes por región {data-icon="ion-earth"}

## Inputs {.sidebar data-width="300"}
```{r}
pickerInput("sexo2",
            label = "Seleccione género",
            choices = sexo_list2,
            selected = sexo_list2, 
            options = list(`actions-box` = TRUE),
          multiple = TRUE)
pickerInput("carrera2",
            label = "Seleccione Carrera",
            choices = carrera_list2,
            selected = carrera_list2, 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)
pickerInput("nacionalidad2",
            label = "Seleccione nacionalidad",
            choices = nacionalidad_list2,
            selected = nacionalidad_list2,
            multiple = TRUE)

pickerInput("region2",
            label = "Seleccione Región",
            choices = region_list2,
            selected = region_list2[1])


actionButton("update2", "Update")

```



## Column

### Mapa de estudiantes por región
```{r}

df_bar2 <- eventReactive(input$update2, {
    print(region_list3)
    print(input$region)
    estudiantesTmp <- estudiantes %>%
      filter(sexo %in% input$sexo2,
             carrera %in% input$carrera2,
             nacionalidad %in% input$nacionalidad2,
             region %in% input$region2
             ) %>%
      group_by(comuna, longitud_comuna, latitud_comuna) %>%
      summarise(cantidad = n())
  })

renderLeaflet({
leaflet() %>%
  #setView(lng = -71.1, lat =42.38, zoom =12) %>%
  addTiles() %>%
  addMarkers(lng = ~longitud_comuna,
             lat = ~latitud_comuna,
             data = df_bar2() ,
            popup = ~paste(
              "Comuna: ", `comuna`, "<br>",
              #"Región: ", `region`, "<br>",
              "Longitud: ", `longitud_comuna`, "<br>",
              "Latitud: ", `latitud_comuna`, "<br>",
            "Cantidad de estudiantes: ", `cantidad`
            )
            ) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addMiniMap()
})



```










# Estudiantes por carrera {data-icon="ion-earth"}

## Inputs {.sidebar data-width="300"}
```{r}
pickerInput("sexo3",
            label = "Seleccione género",
            choices = sexo_list3,
            selected = sexo_list3, 
            options = list(`actions-box` = TRUE),
          multiple = TRUE)
pickerInput("nacionalidad3",
            label = "Seleccione nacionalidad",
            choices = nacionalidad_list3,
            selected = nacionalidad_list3[1], 
            options = list(`actions-box` = TRUE),
            multiple = TRUE)

pickerInput("region3",
            label = "Seleccione Comuna",
            choices = region_list3,
            selected = region_list3[13], 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)

pickerInput("escuela3",
            label = "Seleccione Escuela",
            choices = escuela_list3,
            selected = escuela_list3, 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)


actionButton("update3", "Update")



```



## Column

### Gráfico barra de estudiantes por carrera

```{r}

df_bar3 = eventReactive(input$update3, {
    estudiantesTmp <- estudiantes %>%
      filter(sexo %in% input$sexo3,
             nacionalidad %in% input$nacionalidad3,
             region %in% input$region3,
             escuela %in% input$escuela3
             ) #%>%
      #group_by(comuna) %>%
      #count()
      #summarise(n = n()) #%>%
      #filter(cantidad > 500)
  })


renderPlotly({
p1 <- ggplotly(
  ggplot(data = df_bar3(), mapping = aes(x=carrera, fill=factor(carrera))) +
  #  geom_bar()
  geom_bar()+
  theme_bw() +
  labs(title = "Cantidad de estudiantes por carrera", 
     x = "Carrera", 
     y = "Cantidad",
     fill = "Carrera"
   ) +
  theme(
    axis.title = element_text(size=14,face="bold"),
    axis.text.x = element_blank(),
  )
) 
  })


```

# Distribución de estudiantes por carrera y género {data-icon="ion-stats-bars"}

## Inputs {.sidebar data-width="300"}
```{r}
pickerInput("sexo_line",
            label = "Seleccione género",
            choices = sexo_list,
            selected = sexo_list, 
            options = list(`actions-box` = TRUE),
            multiple = TRUE)

pickerInput("carrera_line",
            label = "Seleccione Carrera",
            choices = carrera_list,
            selected = carrera_list, 
            options = list(`actions-box` = TRUE,
                           `selected-text-format` = "count > 2"),
            multiple = TRUE)

actionButton("update_line", "Update")
```


## Column

### Gráfico para carreras elegidas por hombres
```{r}
df_line <- eventReactive(input$update_line, {
    estudiantes %>%
      filter(sexo %in% input$sexo_line,
             carrera %in% input$carrera_line) %>%
      group_by(carrera, sexo) %>%
      summarise(cantidad = n())
})

output$plot_men <- renderPlotly({
  df_men <- df_line() %>%
    filter(sexo == "Masculino")

  p_men <- ggplot(df_men, aes(x = carrera, y = cantidad, color = carrera, group = carrera)) +
    geom_point(size = 3, aes(text = paste("Carrera: ", carrera, "<br>Cantidad: ", cantidad, "<br>Género: Masculino"))) +
    labs(title = "Carreras elegidas por hombres",
         x = "Carrera",
         y = "Cantidad de estudiantes") +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

  ggplotly(p_men, tooltip = "text")
})

plotlyOutput("plot_men")
```

## Column

### Gráfico para carreras elegidas por mujeres

```{r}
output$plot_women <- renderPlotly({
  df_women <- df_line() %>%
    filter(sexo == "Femenino")

  p_women <- ggplot(df_women, aes(x = carrera, y = cantidad, color = carrera, group = carrera)) +
    geom_point(size = 3, aes(text = paste("Carrera: ", carrera, "<br>Cantidad: ", cantidad, "<br>Género: Femenino"))) +
    labs(title = "Carreras elegidas por mujeres",
         x = "Carrera",
         y = "Cantidad de estudiantes") +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

  ggplotly(p_women, tooltip = "text")
})

plotlyOutput("plot_women")
```

## Column

### Gráfico comparativo entre hombres y mujeres
```{r}
output$plot_comparative <- renderPlotly({
  df_comparative <- df_line() %>%
    filter(sexo %in% c("Masculino", "Femenino"))

  p_comparative <- ggplot(df_comparative, aes(x = carrera, y = cantidad, color = sexo, group = sexo)) +
    geom_line(size = 1.2) +
    geom_point(size = 3, aes(text = paste("Carrera: ", carrera, "<br>Cantidad: ", cantidad, "<br>Género: ", sexo))) +
    labs(title = "Comparación de carreras elegidas por género",
         x = "Carrera",
         y = "Cantidad de estudiantes") +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

  ggplotly(p_comparative, tooltip = "text")
})

plotlyOutput("plot_comparative")
```



## Column

### Informacion de los registros seleccionados

```{r}
table_colnames <- c("Sexo", "Nacionalidad", "Comuna", "Región", "Carrera", "Escuela", "Facultad", "Campus")
df_table2 <- eventReactive(input$update_line, {
    estudiantes %>%
      filter(sexo %in% input$sexo_line,
             carrera %in% input$carrera_line) %>%
      select(sexo, nacionalidad, comuna, region, carrera, escuela, facultad, campus) %>%
    set_colnames(table_colnames)
  })
  
renderDT({
    datatable(df_table2(), 
            extensions = 'Buttons', 
            options = list(
              dom = 'Bfrtip',
              buttons = list(
                'copy', 'print', list(
                  extend = 'collection',
                  buttons = c('csv', 'excel', 'pdf'),
                  text = 'Download'
                )),
              paging = FALSE,
              searching = TRUE,
              orderClasses = TRUE))
  })
```

# About {data-orientation="rows" data-icon="fa-info-circle"}

### **DATA DICTIONARY**

The dataset can be found [here](https://data.cambridgema.gov/Inspectional-Services/Short-Term-Rentals/wxgv-w968/explore/).

The official data dictionary can be found [here](https://data.cambridgema.gov/Inspectional-Services/Short-Term-Rentals/wxgv-w968).

| Column Name                 | Description                                                            |
|---------------------|---------------------------------------------------|
| **ID**                      | Rental ID Number                                                       |
| **Issue Date**              | Date of Issue for the Short Term Rental certificate                    |
| **Address**                 | Address of the STR                                                     |
| **Latitude**                | Latitude of the location                                               |
| **Longitude**               | Longitude of the location                                              |
| **Zipcode**                 | Zipcode of the location                                                |
| **STR Type**                | Response to form question: "Please select the appropriate STR type"    |
| **Property Type**           | Description of the building property type                              |
| **Condominium Association** | Is the Short-Term Rental Unit part of a condominium association?       |
| **Total Bedrooms**          | Total number of legal bedrooms in the short-term rental unit           |
| **Rented Bedrooms**         | Number of legal bedrooms to be rented as part of this application      |
| **Maximum Renter Capacity** | Maximum number of people to which the short term rental will be rented |
| **Kitchen**                 | Will the kitchen be available to the renter?                           |
| **Bathrooms**               | Number of bathrooms available to the renter                            |
| **Airbnb**                  | Whether the rental is listed on this service                           |
| **HomeAway**                | Whether the rental is listed on this service                           |
| **FlipKey**                 | Whether the rental is listed on this service                           |
| **VRBO**                    | Whether the rental is listed on this service                           |
| **Craigslist**              | Whether the rental is listed on this service                           |
| **Couch Surfing**           | Whether the rental is listed on this service                           |
| **Boston Rentals**          | Whether the rental is listed on this service                           |

### **META INFORMATION**

**Title:** Short-term rentals in Cambridge

**Summary:**\
This dataset is part of the **Cambridge's Open Data Program**. It contains information about Short-term rentals (STR) in Cambridge, Massachusetts. STR refers to the rental of any dwelling unit of bedroom as residential accommodation for a duration of less than 30 consecutive days.

Use cases of this dataset include providing valuable insights into the short-term rental market in Cambridge, like understanding the distribution, density and characteristics of STR across Cambridge neighborhoods, which can be useful for a variety of stakeholders, including policymakers, real estate investors, and community organizations.

**Publisher:** [Open Data - City of Cambridge, MA](https://www.cambridgema.gov/departments/opendata)



